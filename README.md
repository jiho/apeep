
# apeep

`apeep` is a set of tools to process images produced by the In Situ Ichthyoplankton Imaging System ([ISIIS](http://yyy.rsmas.miami.edu/groups/larval-fish/isiis.html)).

It is mostly written in Python (a snake), is meant to deal is data form ISIIS (almost [Isis](http://en.wikipedia.org/wiki/Isis), the Egyptian deity) so it is called `apeep`, almost [Apep](http://en.wikipedia.org/wiki/Apep), an Egyptian deity which takes the form of a giant snake! And it is supposed to churn through your data without a peep, of course. (Yes, finding the name took longer than coding the thing...)


## Installation

Install external libraries needed by `apeep` and/or the packages it depends on

    sudo apt install cmake pkg-config libavcodec-dev libavformat-dev libavdevice-dev libavutil-dev libpng-dev libjpeg-dev 
    
Install `pip` for python 3 (usually called `pip3`)

    sudo apt install python3-pip

Install `apeep` from this repository

    pip3 install git+https://github.com/jiho/apeep

This should install other python packages `apeep` depends on. 

If you install as a regular user, `apeep` installs in `~/.local/` and you need to make sure that `~/.local/bin` is in your `PATH` to be able to run it. Typically, this is done by editing `~/.bashrc` and writing

    export PATH="~/.local/bin:${PATH}"

If you install with `sudo pip3 ...` then `apeep` should be installed in `/usr/local` and should already be in your `PATH`.

# Usage

`apeep` takes `.avi` files from ISIIS, flat-fields them with a moving average, increases the contrasts of the resulting image, detects objects and extracts them, together with some measurements of each individual object.

It needs an **input** directory with a sequence of `.avi` files generated by ISIIS (typically along a given transect) and will create a **project** directory, which contains the configuration file and the output files (full processed frames and/or segmented objects).

It runs as a command line tool installed with the python package. Run it first to create and initialise the project directory

    apeep /path/to/project
    # This fails with
    # "FileNotFoundError: input directory /path/to/data does not exist"
    # which is expected

Now you can edit the configuration file that is in `/path/to/project/config.yaml` with a simple text editor. The configuration options are documented [here](https://github.com/jiho/apeep/blob/master/apeep/config.yaml). Once the options are set (at least the path to the input directory), re-run the same project with `apeep` and it should start processing the data

    apeep /path/to/project


## Development

To change `apeep`'s code, clone this repository, edit the code, and run the *local* version of the package rather than the pip-installed one

    git clone https://github.com/jiho/apeep.git
    cd apeep
    # edit what you need to edit, then
    python3 -m apeep --debug /path/to/project

To test new code, it is useful to have a dedicated test project. A repository with test files is available. To use it

    wget https://github.com/jiho/apeep_test/archive/master.zip
    unzip master.zip
    python3 -m apeep apeep_test-master/out

When developing new functionality, it is often useful to place one self in a given context (inside a function, within the main loop, etc.). To stop execution at any point and jump into a python interpreter, uncomment the line

    # from ipdb import set_trace as db

at the beginning of the file of interest and write `db()` at the point at which you want to stop in the file. You will enter python interactive debugger (the prompt is `idbp>`). You can run code there, but it will not execute multiline statements. Do do so, within the debugger, type `interact` which opens a temporary interactive python session.


## Credits

ISIIS is developed by [Robert K Cowen](http://ceoas.oregonstate.edu/profile/cowen/) ([Rosenstiel School of Marine and Atmospheric Sciences](http://www.rsmas.miami.edu/) RSMAS, University of Miami and [Hatfield Marine Science Center](http://hmsc.oregonstate.edu), Oregon State University) and [Cédric Guigand](http://yyy.rsmas.miami.edu/groups/larval-fish/cedric.html) ([RSMAS](http://www.rsmas.miami.edu)) in partnership with [BellaMare](http://www.bellamare-us.com).

`apeep` is coded by [Jean-Olivier Irisson](http://www.obs-vlfr.fr/~irisson/) ([Laboratoire d'Océanographie de Villefranche](http://lov.obs-vlfr.fr) LOV) and released under the [GNU General Public License v3](http://www.gnu.org/copyleft/gpl.html).
